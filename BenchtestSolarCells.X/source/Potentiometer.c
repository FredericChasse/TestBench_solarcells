//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
//
// Chinook Project Template
//
//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
//
// File    : Potentiometer.c
// Author  : Frederic Chasse
// Date    : 2015-01-03
//
//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
//
// Purpose : This is the C file for the functions of the potentiometers AD8403.
//
//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
//
// Notes   : None.
//
//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

#include "..\headers\Potentiometer.h"


//==============================================================================
// Potentiometer variables
//==============================================================================
const float potRealValues[256] =  { 50        , 53.9063   , 57.8125 , 61.7188 , 65.625  , 69.5313
                                  , 73.4375   , 77.3438   , 81.25   , 85.1563 , 89.0625 , 92.9688
                                  , 96.875    , 100.7813  , 104.6875, 108.5938, 112.5   , 116.4063
                                  , 120.3125  , 124.2188  , 128.125, 132.0313, 135.9375, 139.8438
                                  , 143.75    , 147.6563  , 151.5625, 155.4688, 159.375, 163.2813
                                  , 167.1875  , 171.0938  , 175, 178.9063, 182.8125, 186.7188
                                  , 190.625   , 194.5313  , 198.4375, 202.3438, 206.25, 210.1563
                                  , 214.0625  , 217.9688  , 221.875, 225.7813, 229.6875, 233.5938
                                  , 237.5     , 241.4063  , 245.3125, 249.2188, 253.125, 257.0313
                                  , 260.9375  , 264.8438  , 268.75, 272.6563, 276.5625, 280.4688
                                  , 284.375   , 288.2813  , 292.1875, 296.0938, 300, 303.9063
                                  , 307.8125  , 311.7188  , 315.625, 319.5313, 323.4375, 327.3438
                                  , 331.25    , 335.1563  , 339.0625, 342.9688, 346.875, 350.7813
                                  , 354.6875  , 358.5938  , 362.5, 366.4063, 370.3125, 374.2188
                                  , 378.125   , 382.0313  , 385.9375, 389.8438, 393.75, 397.6563
                                  , 401.5625  , 405.4688  , 409.375, 413.2813, 417.1875, 421.0938
                                  , 425       , 428.9063  , 432.8125, 436.7188, 440.625, 444.5313
                                  , 448.4375  , 452.3438  , 456.25, 460.1563, 464.0625, 467.9688
                                  , 471.875   , 475.7813  , 479.6875, 483.5938, 487.5, 491.4063
                                  , 495.3125  , 499.2188  , 503.125, 507.0313, 510.9375, 514.8438
                                  , 518.75    , 522.6563  , 526.5625, 530.4688, 534.375, 538.2813
                                  , 542.1875  , 546.0938  , 550, 553.9063, 557.8125, 561.7188
                                  , 565.625   , 569.5313  , 573.4375, 577.3438, 581.25, 585.1563
                                  , 589.0625  , 592.9688  , 596.875, 600.7813, 604.6875, 608.5938
                                  , 612.5     , 616.4063  , 620.3125, 624.2188, 628.125, 632.0313
                                  , 635.9375  , 639.8438  , 643.75, 647.6563, 651.5625, 655.4688
                                  , 659.375   , 663.2813  , 667.1875, 671.0938, 675, 678.9063
                                  , 682.8125  , 686.7188  , 690.625, 694.5313, 698.4375, 702.3438
                                  , 706.25    , 710.1563  , 714.0625, 717.9688, 721.875, 725.7813
                                  , 729.6875  , 733.5938  , 737.5, 741.4063, 745.3125, 749.2188
                                  , 753.125   , 757.0313  , 760.9375, 764.8438, 768.75, 772.6563
                                  , 776.5625  , 780.4688  , 784.375, 788.2813, 792.1875, 796.0938
                                  , 800       , 803.9063  , 807.8125, 811.7188, 815.625, 819.5313
                                  , 823.4375  , 827.3438  , 831.25, 835.1563, 839.0625, 842.9688
                                  , 846.875   , 850.7813  , 854.6875, 858.5938, 862.5, 866.4063
                                  , 870.3125  , 874.2188  , 878.125, 882.0313, 885.9375, 889.8438
                                  , 893.75    , 897.6563  , 901.5625, 905.4688, 909.375, 913.2813
                                  , 917.1875  , 921.0938  , 925, 928.9063, 932.8125, 936.7188
                                  , 940.625   , 944.5313  , 948.4375, 952.3438, 956.25, 960.1563
                                  , 964.0625  , 967.9688  , 971.875, 975.7813, 979.6875, 983.5938
                                  , 987.5     , 991.4063  , 995.3125, 999.2188, 1003.125, 1007.0313
                                  , 1010.9375 , 1014.8438 , 1018.75, 1022.6563, 1026.5625, 1030.4688
                                  , 1034.375  , 1038.2813 , 1042.1875, 1046.0938
                                  };


//==============================================================================
// Potentiometer private functions prototypes
//==============================================================================


//==============================================================================
// Potentiometers functions
//==============================================================================


/**************************************************************
 * Function name  : ShutdownPot
 * Purpose        : Shutdown a potentiometer.
 * Arguments      : UINT8 numPot : the number of the pot (0-3).
 * Returns        : 0 on success, -1 on failure.
 *************************************************************/
inline INT8 ShutdownPot(UINT8 numPot)
{
  if (numPot >= 4)
  {
    return -1;
  }
  Port.D.ClearBits(1 << (numPot + 8));
  return 0;
}


/**************************************************************
 * Function name  : TurnOnPot
 * Purpose        : Turn on a potentiometer.
 * Arguments      : UINT8 numPot : the number of the pot (0-3).
 * Returns        : 0 on success, -1 on failure.
 *************************************************************/
inline INT8 TurnOnPot(UINT8 numPot)
{
  if (numPot >= 4)
  {
    return -1;
  }
  Port.D.SetBits(1 << (numPot + 8));
  return 0;
}


/**************************************************************
 * Function name  : ResetPot
 * Purpose        : Reset a pot at its mid-value.
 * Arguments      : UINT8 numPot : the number of the pot (0-3).
 * Returns        : 0 on success, -1 on failure.
 *************************************************************/
inline INT8 ResetPot(UINT8 numPot)
{
  if (numPot >= 4)
  {
    return -1;
  }
  UINT8 i = 0;
  Port.E.ClearBits(1 << numPot);
  for (i = 0; i < 200; i++);
  Port.E.SetBits  (1 << numPot);
  return 0;
}


/**************************************************************
 * Function name  : ComputePotValue
 * Purpose        : Converts an ohmic value to a range of 0-255.
 * Arguments      : UINT32 desiredValue, in ohms.
 * Returns        : value on success, -1 on failure.
 *************************************************************/
inline INT16 ComputePotValue(UINT32 desiredValue)
{
  if ( !((desiredValue <= MAX_POT_VALUE) && (desiredValue >= WIPER_VALUE)) )
  {
    return -1;
  }
  return ((float) ((desiredValue - WIPER_VALUE) / MAX_POT_VALUE)) + 0.5;
}


/**************************************************************
 * Function name  : SetPotAllUnits
 * Purpose        : Set all units of a pot to the same value.
 * Arguments      : UINT8 numPot : the number of the pot (0-3)
 *                  UINT8 index : pot index (0 - 3)
 *                  UINT8 value : pot increment (0 - 255)
 * Returns        : 0 on success, -1 on failure.
 *************************************************************/
inline INT8 SetPotAllUnits (UINT8 numPot, UINT8 value)
{
  if (numPot >= 4)
  {
    return -1;
  }
  
  SetPot(numPot, 0, value);
  SetPot(numPot, 1, value);
  SetPot(numPot, 2, value);
  SetPot(numPot, 3, value);

  return 0;
}


/**************************************************************
 * Function name  : SetPot
 * Purpose        : Set the value of a potentiometer.
 * Arguments      : UINT8 numPot : the number of the pot (0-3)
 *                  UINT8 index : pot index (0 - 3)
 *                  UINT8 value : pot increment (0 - 255)
 * Returns        : 0 on success, -1 on failure.
 *************************************************************/
inline INT8 SetPot (UINT8 numPot, UINT16 index, UINT8 value)
{
  if (numPot >= 4)
  {
    return -1;
  }
  if (index >= 4)
  {
    return -1;
  }
  
  while(Spi.IsSpiBusy(SPI3));
  Port.D.ClearBits(1 << (numPot + 4));
  Spi.SendCharacter( SPI3, ( (index << 8) | value ) );
  while(Spi.IsSpiBusy(SPI3));
  Port.D.SetBits(1 << (numPot + 4));

  return 0;
}


/**************************************************************
 * Function name  : InitPot
 * Purpose        : Initialize a potentiometer.
 * Arguments      : UINT8 numPot : the number of the pot (0-3).
 * Returns        : 0 on success, -1 on failure.
 *************************************************************/
inline INT8 InitPot (UINT8 numPot)
{
  if (numPot >= 4)
  {
    return -1;
  }
  
  TurnOnPot(numPot);
  
  ResetPot(numPot);

  return 0;
}