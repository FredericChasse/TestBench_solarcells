//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
//
// Chinook Project Template
//
//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
//
// File    : Potentiometer.c
// Author  : Frederic Chasse
// Date    : 2015-01-03
//
//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
//
// Purpose : This is the C file for the functions of the potentiometers AD8403.
//
//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
//
// Notes   : None.
//
//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

#include "..\headers\Potentiometer.h"


//==============================================================================
// Potentiometer variables
//==============================================================================
const float potRealValues[256] =  { 50        , 53.9063   , 57.8125 , 61.7188 , 65.625  , 69.5313
                                  , 73.4375   , 77.3438   , 81.25   , 85.1563 , 89.0625 , 92.9688
                                  , 96.875    , 100.7813  , 104.6875, 108.5938, 112.5   , 116.4063
                                  , 120.3125  , 124.2188  , 128.125, 132.0313, 135.9375, 139.8438
                                  , 143.75    , 147.6563  , 151.5625, 155.4688, 159.375, 163.2813
                                  , 167.1875  , 171.0938  , 175, 178.9063, 182.8125, 186.7188
                                  , 190.625   , 194.5313  , 198.4375, 202.3438, 206.25, 210.1563
                                  , 214.0625  , 217.9688  , 221.875, 225.7813, 229.6875, 233.5938
                                  , 237.5     , 241.4063  , 245.3125, 249.2188, 253.125, 257.0313
                                  , 260.9375  , 264.8438  , 268.75, 272.6563, 276.5625, 280.4688
                                  , 284.375   , 288.2813  , 292.1875, 296.0938, 300, 303.9063
                                  , 307.8125  , 311.7188  , 315.625, 319.5313, 323.4375, 327.3438
                                  , 331.25    , 335.1563  , 339.0625, 342.9688, 346.875, 350.7813
                                  , 354.6875  , 358.5938  , 362.5, 366.4063, 370.3125, 374.2188
                                  , 378.125   , 382.0313  , 385.9375, 389.8438, 393.75, 397.6563
                                  , 401.5625  , 405.4688  , 409.375, 413.2813, 417.1875, 421.0938
                                  , 425       , 428.9063  , 432.8125, 436.7188, 440.625, 444.5313
                                  , 448.4375  , 452.3438  , 456.25, 460.1563, 464.0625, 467.9688
                                  , 471.875   , 475.7813  , 479.6875, 483.5938, 487.5, 491.4063
                                  , 495.3125  , 499.2188  , 503.125, 507.0313, 510.9375, 514.8438
                                  , 518.75    , 522.6563  , 526.5625, 530.4688, 534.375, 538.2813
                                  , 542.1875  , 546.0938  , 550, 553.9063, 557.8125, 561.7188
                                  , 565.625   , 569.5313  , 573.4375, 577.3438, 581.25, 585.1563
                                  , 589.0625  , 592.9688  , 596.875, 600.7813, 604.6875, 608.5938
                                  , 612.5     , 616.4063  , 620.3125, 624.2188, 628.125, 632.0313
                                  , 635.9375  , 639.8438  , 643.75, 647.6563, 651.5625, 655.4688
                                  , 659.375   , 663.2813  , 667.1875, 671.0938, 675, 678.9063
                                  , 682.8125  , 686.7188  , 690.625, 694.5313, 698.4375, 702.3438
                                  , 706.25    , 710.1563  , 714.0625, 717.9688, 721.875, 725.7813
                                  , 729.6875  , 733.5938  , 737.5, 741.4063, 745.3125, 749.2188
                                  , 753.125   , 757.0313  , 760.9375, 764.8438, 768.75, 772.6563
                                  , 776.5625  , 780.4688  , 784.375, 788.2813, 792.1875, 796.0938
                                  , 800       , 803.9063  , 807.8125, 811.7188, 815.625, 819.5313
                                  , 823.4375  , 827.3438  , 831.25, 835.1563, 839.0625, 842.9688
                                  , 846.875   , 850.7813  , 854.6875, 858.5938, 862.5, 866.4063
                                  , 870.3125  , 874.2188  , 878.125, 882.0313, 885.9375, 889.8438
                                  , 893.75    , 897.6563  , 901.5625, 905.4688, 909.375, 913.2813
                                  , 917.1875  , 921.0938  , 925, 928.9063, 932.8125, 936.7188
                                  , 940.625   , 944.5313  , 948.4375, 952.3438, 956.25, 960.1563
                                  , 964.0625  , 967.9688  , 971.875, 975.7813, 979.6875, 983.5938
                                  , 987.5     , 991.4063  , 995.3125, 999.2188, 1003.125, 1007.0313
                                  , 1010.9375 , 1014.8438 , 1018.75, 1022.6563, 1026.5625, 1030.4688
                                  , 1034.375  , 1038.2813 , 1042.1875, 1046.0938
                                  };

const float potRealValuesInverse[256] = { 0.02, 0.018551, 0.017297, 0.016203, 0.015238, 0.014382, 0.013617
                                        , 0.012929, 0.012308, 0.011743, 0.011228, 0.010756, 0.010323, 0.0099225
                                        , 0.0095522, 0.0092086, 0.0088889, 0.0085906, 0.0083117, 0.0080503, 0.0078049
                                        , 0.007574, 0.0073563, 0.0071508, 0.0069565, 0.0067725, 0.0065979, 0.0064322
                                        , 0.0062745, 0.0061244, 0.0059813, 0.0058447, 0.0057143, 0.0055895, 0.0054701
                                        , 0.0053556, 0.0052459, 0.0051406, 0.0050394, 0.0049421, 0.0048485, 0.0047584
                                        , 0.0046715, 0.0045878, 0.004507, 0.0044291, 0.0043537, 0.0042809, 0.0042105
                                        , 0.0041424, 0.0040764, 0.0040125, 0.0039506, 0.0038906, 0.0038323, 0.0037758
                                        , 0.0037209, 0.0036676, 0.0036158, 0.0035655, 0.0035165, 0.0034688, 0.0034225
                                        , 0.0033773, 0.0033333, 0.0032905, 0.0032487, 0.003208, 0.0031683, 0.0031296
                                        , 0.0030918, 0.0030549, 0.0030189, 0.0029837, 0.0029493, 0.0029157, 0.0028829
                                        , 0.0028508, 0.0028194, 0.0027887, 0.0027586, 0.0027292, 0.0027004, 0.0026722
                                        , 0.0026446, 0.0026176, 0.0025911, 0.0025651, 0.0025397, 0.0025147, 0.0024903
                                        , 0.0024663, 0.0024427, 0.0024197, 0.002397, 0.0023748, 0.0023529, 0.0023315
                                        , 0.0023105, 0.0022898, 0.0022695, 0.0022496, 0.00223, 0.0022107, 0.0021918
                                        , 0.0021732, 0.0021549, 0.0021369, 0.0021192, 0.0021018, 0.0020847, 0.0020679
                                        , 0.0020513, 0.002035, 0.0020189, 0.0020031, 0.0019876, 0.0019723, 0.0019572
                                        , 0.0019423, 0.0019277, 0.0019133, 0.0018991, 0.0018851, 0.0018713, 0.0018578
                                        , 0.0018444, 0.0018312, 0.0018182, 0.0018054, 0.0017927, 0.0017803, 0.001768
                                        , 0.0017558, 0.0017439, 0.0017321, 0.0017204, 0.0017089, 0.0016976, 0.0016864
                                        , 0.0016754, 0.0016645, 0.0016537, 0.0016431, 0.0016327, 0.0016223, 0.0016121
                                        , 0.001602, 0.001592, 0.0015822, 0.0015725, 0.0015629, 0.0015534, 0.001544
                                        , 0.0015348, 0.0015256, 0.0015166, 0.0015077, 0.0014988, 0.0014901, 0.0014815
                                        , 0.001473, 0.0014645, 0.0014562, 0.001448, 0.0014398, 0.0014318, 0.0014238
                                        , 0.0014159, 0.0014081, 0.0014004, 0.0013928, 0.0013853, 0.0013778, 0.0013704
                                        , 0.0013632, 0.0013559, 0.0013488, 0.0013417, 0.0013347, 0.0013278, 0.0013209
                                        , 0.0013142, 0.0013075, 0.0013008, 0.0012942, 0.0012877, 0.0012813, 0.0012749
                                        , 0.0012686, 0.0012623, 0.0012561, 0.00125, 0.0012439, 0.0012379, 0.001232
                                        , 0.0012261, 0.0012202, 0.0012144, 0.0012087, 0.001203, 0.0011974, 0.0011918
                                        , 0.0011863, 0.0011808, 0.0011754, 0.00117, 0.0011647, 0.0011594, 0.0011542
                                        , 0.001149, 0.0011439, 0.0011388, 0.0011337, 0.0011287, 0.0011238, 0.0011189
                                        , 0.001114, 0.0011092, 0.0011044, 0.0010997, 0.001095, 0.0010903, 0.0010857
                                        , 0.0010811, 0.0010765, 0.001072, 0.0010676, 0.0010631, 0.0010587, 0.0010544
                                        , 0.00105, 0.0010458, 0.0010415, 0.0010373, 0.0010331, 0.0010289, 0.0010248
                                        , 0.0010207, 0.0010167, 0.0010127, 0.0010087, 0.0010047, 0.0010008, 0.00099688
                                        , 0.00099302, 0.00098918, 0.00098537, 0.0009816, 0.00097785, 0.00097412
                                        , 0.00097043, 0.00096677, 0.00096313, 0.00095952, 0.00095594
                                        };

//==============================================================================
// Potentiometer private functions prototypes
//==============================================================================


//==============================================================================
// Potentiometers functions
//==============================================================================


/**************************************************************
 * Function name  : ShutdownPot
 * Purpose        : Shutdown a potentiometer.
 * Arguments      : UINT8 numPot : the number of the pot (0-3).
 * Returns        : 0 on success, -1 on failure.
 *************************************************************/
inline INT8 ShutdownPot(UINT8 numPot)
{
  if (numPot >= 4)
  {
    return -1;
  }
  Port.D.ClearBits(1 << (numPot + 8));
  return 0;
}


/**************************************************************
 * Function name  : TurnOnPot
 * Purpose        : Turn on a potentiometer.
 * Arguments      : UINT8 numPot : the number of the pot (0-3).
 * Returns        : 0 on success, -1 on failure.
 *************************************************************/
inline INT8 TurnOnPot(UINT8 numPot)
{
  if (numPot >= 4)
  {
    return -1;
  }
  Port.D.SetBits(1 << (numPot + 8));
  return 0;
}


/**************************************************************
 * Function name  : ResetPot
 * Purpose        : Reset a pot at its mid-value.
 * Arguments      : UINT8 numPot : the number of the pot (0-3).
 * Returns        : 0 on success, -1 on failure.
 *************************************************************/
inline INT8 ResetPot(UINT8 numPot)
{
  if (numPot >= 4)
  {
    return -1;
  }
  UINT8 i = 0;
  Port.E.ClearBits(1 << numPot);
  for (i = 0; i < 200; i++);
  Port.E.SetBits  (1 << numPot);
  return 0;
}


/**************************************************************
 * Function name  : ComputePotValueFloat2Dec
 * Purpose        : Converts an ohmic value to a range of 0-255.
 * Arguments      : float desiredValue, in ohms.
 * Returns        : value on success, -1 on failure.
 *************************************************************/
inline INT16 ComputePotValueFloat2Dec(float desiredValue)
{
  if ( !((desiredValue <= MAX_POT_VALUE) && (desiredValue >= WIPER_VALUE)) )
  {
    return -1;
  }
  return ((float) ((desiredValue - WIPER_VALUE) / (MAX_POT_VALUE - WIPER_VALUE)) * 255) + 0.5;
}


/**************************************************************
 * Function name  : ComputePotValueDec2Float
 * Purpose        : Converts a range of 0-255 to an ohmic value.
 * Arguments      : UINT8 decimal value [0 - 255]
 *                  float *realValue : address of the result
 * Returns        : None.
 *************************************************************/
inline void ComputePotValueDec2Float(UINT8 desiredValue, float *realValue)
{
  *realValue = (float) desiredValue * (MAX_POT_VALUE - WIPER_VALUE) / 255.0 + 50;
}


/**************************************************************
 * Function name  : SetPotAllUnits
 * Purpose        : Set all units of a pot to the same value.
 * Arguments      : UINT8 numPot : the number of the pot (0-3)
 *                  UINT8 index : pot index (0 - 3)
 *                  UINT8 value : pot increment (0 - 255)
 * Returns        : 0 on success, -1 on failure.
 *************************************************************/
inline INT8 SetPotAllUnits (UINT8 numPot, UINT8 value)
{
  if (numPot >= 4)
  {
    return -1;
  }
  
  SetPot(numPot, 0, value);
  SetPot(numPot, 1, value);
  SetPot(numPot, 2, value);
  SetPot(numPot, 3, value);

  return 0;
}


/**************************************************************
 * Function name  : SetPot
 * Purpose        : Set the value of a potentiometer.
 * Arguments      : UINT8 numPot : the number of the pot (0-3)
 *                  UINT8 index : pot index (0 - 3)
 *                  UINT8 value : pot increment (0 - 255)
 * Returns        : 0 on success, -1 on failure.
 *************************************************************/
inline INT8 SetPot (UINT8 numPot, UINT16 index, UINT8 value)
{
  if (numPot >= 4)
  {
    return -1;
  }
  if (index >= 4)
  {
    return -1;
  }
  
  while(Spi.IsSpiBusy(SPI3));
  Port.D.ClearBits(1 << (numPot + 4));
  Spi.SendCharacter( SPI3, ( (index << 8) | value ) );
  while(Spi.IsSpiBusy(SPI3));
  Port.D.SetBits(1 << (numPot + 4));

  return 0;
}


/**************************************************************
 * Function name  : InitPot
 * Purpose        : Initialize a potentiometer.
 * Arguments      : UINT8 numPot : the number of the pot (0-3).
 * Returns        : 0 on success, -1 on failure.
 *************************************************************/
inline INT8 InitPot (UINT8 numPot)
{
  if (numPot >= 4)
  {
    return -1;
  }
  
  TurnOnPot(numPot);
  
  ResetPot(numPot);

  return 0;
}